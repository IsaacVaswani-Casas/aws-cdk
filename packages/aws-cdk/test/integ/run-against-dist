#!/bin/bash
set -eu
# This is a backwards compatibility script. All logic has moved to '@aws-cdk-testing/cli-integ'
# and should be called from there directly.

export VERSION=$(node -pe "require('./build.json').version")

# The package MUST be 'npm install'ed from the package repository (`npm install --production`
# will not work because that will resolve devDependencies even though it will not install them),
# but it may not live in a 'node_modules' directory because Jest 27 does not support that. Do contortions.
export INTEG_TOOLS=cli_integ
rm -rf $INTEG_TOOLS && mkdir $INTEG_TOOLS
npm install --prefix $INTEG_TOOLS --no-save ./js/aws-cdk-testing-cli-integ-*.tgz
mv $($INTEG_TOOLS/node_modules/.bin/test-root)/* $INTEG_TOOLS

# Not strictly part of this but hey
(
  sudo apt-get update
  sudo apt-get install -y curl
  curl -fSsL "https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/debian_amd64/amazon-ssm-agent.deb" -o /tmp/amazon-ssm-agent.deb
  sudo dpkg -i /tmp/amazon-ssm-agent.deb
  sudo mkdir -p /etc/amazon/ssm
  sudo curl -fSsL "https://raw.githubusercontent.com/aws/aws-codebuild-docker-images/master/ubuntu/standard/4.0/amazon-ssm-agent.json" -o /etc/amazon/ssm/amazon-ssm-agent.json
  sleep 10
  codebuild-breakpoint
)

CONCURRENCY=5 exec ${INTEG_TOOLS}/bin/stage-distribution run . "$@"
