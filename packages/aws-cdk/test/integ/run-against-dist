#!/bin/bash
set -eu
# This is a backwards compatibility script. All logic has moved to '@aws-cdk-testing/cli-integ'
# and should be called from there directly.

export VERSION=$(node -pe "require('./build.json').version")

# The package MUST be 'npm install'ed (because its devDependencies are not up on NPMJS) but it may not
# live in a 'node_modules' directory because Jest 27 does not support that. Do contortions.
export INTEG_TOOLS=cli_integ
rm -rf $INTEG_TOOLS && mkdir $INTEG_TOOLS
npm install --prefix $INTEG_TOOLS --no-save ./js/aws-cdk-testing-cli-integ-*.tgz
mv $($INTEG_TOOLS/node_modules/.bin/test-root)/* $INTEG_TOOLS

CONCURRENCY=1 exec ${INTEG_TOOLS}/bin/stage-distribution run . "$@"
